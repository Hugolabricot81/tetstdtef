<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GÃ©oClasse â€” DÃ©fi de Localisation</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06090c;--surface:#0e1419;--surface2:#161e26;--surface3:#1d2733;
  --border:#1e2d3d;--border2:#253545;
  --emerald:#10b981;--emerald-dim:#064e3b;--emerald-glow:#10b98133;
  --blue:#3b82f6;--blue-dim:#1e3a5f;
  --amber:#f59e0b;--red:#ef4444;
  --text:#e2e8f0;--muted:#64748b;--muted2:#94a3b8;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;}
.screen{position:fixed;inset:0;display:none;overflow:hidden;}
.screen.active{display:flex;}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'Syne',sans-serif;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s;}
.input:focus{border-color:var(--emerald);box-shadow:0 0 0 3px var(--emerald-glow);}
.btn{border:none;border-radius:10px;padding:11px 20px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .15s;letter-spacing:.3px;}
.btn:hover{transform:translateY(-1px);}
.btn:active{transform:translateY(0);}
.btn-green{background:linear-gradient(135deg,var(--emerald),#059669);color:#fff;box-shadow:0 4px 16px var(--emerald-glow);}
.btn-green:hover{box-shadow:0 8px 24px #10b98144;}
.btn-blue{background:linear-gradient(135deg,var(--blue),#2563eb);color:#fff;}
.btn-red{background:linear-gradient(135deg,var(--red),#dc2626);color:#fff;}
.btn-ghost{background:var(--surface2);border:1px solid var(--border2);color:var(--muted2);}
.btn-ghost:hover{color:var(--text);border-color:var(--blue);}
.label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;}
.tag{display:inline-block;padding:3px 9px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;}
.tag-easy{background:#064e3b;color:#34d399;}
.tag-medium{background:#78350f;color:#fbbf24;}
.tag-hard{background:#7f1d1d;color:#fca5a5;}
.tag-expert{background:#312e81;color:#a5b4fc;}
.tag-all{background:var(--surface3);color:var(--muted2);}

.grid-bg{position:absolute;inset:0;opacity:.07;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:50px 50px;animation:gridMove 25s linear infinite;pointer-events:none;}
@keyframes gridMove{from{background-position:0 0}to{background-position:50px 50px}}

/* WELCOME */
#s-welcome{flex-direction:column;align-items:center;justify-content:center;background:var(--bg);}
#s-welcome::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 0%,#0d2235 0%,transparent 70%),radial-gradient(ellipse 40% 40% at 80% 85%,#071a0f 0%,transparent 60%);pointer-events:none;}
.welcome-card{position:relative;z-index:10;background:rgba(14,20,25,.92);border:1px solid var(--border);border-radius:24px;padding:36px;width:100%;max-width:400px;backdrop-filter:blur(20px);box-shadow:0 32px 80px #00000080;}
.logo-badge{width:72px;height:72px;background:linear-gradient(135deg,var(--emerald),#059669);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 20px;animation:logoPulse 3s ease-in-out infinite;box-shadow:0 0 40px var(--emerald-glow);}
@keyframes logoPulse{0%,100%{box-shadow:0 0 40px var(--emerald-glow)}50%{box-shadow:0 0 70px #10b98155}}

/* WAITING */
#s-waiting{flex-direction:column;align-items:center;justify-content:center;background:var(--bg);position:relative;}
#s-waiting::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 70% at 50% 50%,#071a0f 0%,transparent 70%);pointer-events:none;}
.orbit-wrap{width:180px;height:180px;position:relative;margin:0 auto 32px;}
.orbit-ring{position:absolute;border-radius:50%;border:1px solid;animation:spin 8s linear infinite;}
.orbit-ring:nth-child(1){inset:0;border-color:rgba(16,185,129,.35);}
.orbit-ring:nth-child(2){inset:24px;border-color:rgba(59,130,246,.25);animation-duration:13s;animation-direction:reverse;}
.orbit-ring:nth-child(3){inset:48px;border-color:rgba(16,185,129,.15);animation-duration:18s;}
.orbit-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:36px;}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.player-chip{background:var(--surface2);border:1px solid var(--border2);border-radius:999px;padding:5px 14px;font-size:12px;color:var(--muted2);animation:chipIn .3s ease;}
@keyframes chipIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

/* GAME */
#s-game{flex-direction:column;background:#000;}
#pano-wrap{flex:6;position:relative;overflow:hidden;min-height:0;}
#panorama::-webkit-scrollbar{display:none!important;}
#panorama{width:100%;height:100%;}
#map-wrap{flex:4;position:relative;border-top:2px solid var(--border);min-height:0;}
#game-map{width:100%;height:100%;}
.hud{position:absolute;top:14px;left:14px;right:14px;z-index:1000;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
.score-pill{background:rgba(6,9,12,.88);border:1px solid var(--border2);border-radius:999px;padding:8px 18px;backdrop-filter:blur(12px);font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:var(--emerald);}
#btn-validate{pointer-events:all;background:linear-gradient(135deg,var(--emerald),#059669);border:none;border-radius:999px;padding:11px 24px;color:#fff;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .2s;box-shadow:0 4px 20px var(--emerald-glow);}
#btn-validate:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 8px 28px #10b98155;}

/* RESULT */
#result-overlay{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.88);backdrop-filter:blur(10px);display:none;flex-direction:column;align-items:center;justify-content:center;}
#result-overlay.show{display:flex;animation:fadeUp .4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.result-card{background:var(--surface);border:1px solid var(--border2);border-radius:28px;padding:44px 40px;text-align:center;max-width:380px;width:92%;box-shadow:0 32px 80px #00000090;}
.result-big{font-size:76px;font-weight:800;background:linear-gradient(135deg,var(--emerald),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'DM Mono',monospace;line-height:1;}
.progress-bar{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin:16px 0 8px;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--emerald),#34d399);border-radius:3px;transition:width 1.2s ease;}
.result-bar{display:flex;justify-content:center;gap:24px;margin:16px 0;padding:16px;background:var(--surface2);border-radius:14px;}

/* ADMIN */
#s-admin{flex-direction:column;background:var(--bg);}
.admin-topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;gap:12px;}
.admin-body{display:grid;grid-template-columns:300px 1fr;flex:1;overflow:hidden;min-height:0;}
.admin-sidebar{border-right:1px solid var(--border);overflow-y:auto;padding:16px;}
.admin-main{overflow-y:auto;padding:20px;}
.section-title{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.preset-btn{width:100%;text-align:left;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 11px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:border-color .15s,background .15s;display:flex;align-items:center;gap:9px;margin-bottom:5px;}
.preset-btn:hover{border-color:var(--blue);background:var(--surface3);}
.preset-btn.selected{border-color:var(--emerald);background:rgba(16,185,129,.08);}
.preset-info{flex:1;min-width:0;}
.preset-name{font-weight:700;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.preset-region{font-size:10px;color:var(--muted);margin-top:1px;}
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;}
.stat-num{font-size:28px;font-weight:800;font-family:'DM Mono',monospace;line-height:1;}
.stat-lbl{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-top:4px;}
.tab-bar{display:flex;gap:4px;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:18px;}
.tab{flex:1;text-align:center;padding:8px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted);border:none;background:transparent;font-family:'Syne',sans-serif;transition:background .2s,color .2s;}
.tab.active{background:var(--surface3);color:var(--text);}
.tab-pane{display:none;}
.tab-pane.active{display:block;}
.lb-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;margin-bottom:4px;}
.lb-gold{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);}
.lb-silver{background:rgba(148,163,184,.06);border:1px solid rgba(148,163,184,.15);}
.lb-bronze{background:rgba(180,100,40,.08);border:1px solid rgba(180,100,40,.2);}
.lb-normal{background:var(--surface2);border:1px solid var(--border);}
.mono-score{font-family:'DM Mono',monospace;font-size:17px;font-weight:700;color:var(--emerald);}
.diff-filter{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px;}

@media(max-width:680px){
  .admin-body{grid-template-columns:1fr;grid-template-rows:220px 1fr;}
  .admin-sidebar{border-right:none;border-bottom:1px solid var(--border);overflow-y:auto;}
  .stat-grid{grid-template-columns:repeat(3,1fr);}
}
@media(orientation:landscape) and (max-height:500px){
  #s-game{flex-direction:row;}
  #pano-wrap{flex:6;border-top:none;border-right:2px solid var(--border);}
  #map-wrap{flex:4;}
}
.leaflet-control-attribution{display:none!important;}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WELCOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-welcome" class="screen active">
  <div class="grid-bg"></div>
  <div class="welcome-card">
    <div class="logo-badge">ğŸŒ</div>
    <h1 style="text-align:center;font-size:26px;font-weight:800;letter-spacing:-.5px;margin-bottom:4px;">GÃ©oClasse</h1>
    <p style="text-align:center;color:var(--muted);font-size:11px;letter-spacing:2.5px;text-transform:uppercase;margin-bottom:28px;">DÃ©fi de Localisation</p>
    <div style="margin-bottom:14px;">
      <label class="label">Ton pseudo</label>
      <input id="inp-pseudo" class="input" type="text" placeholder="Ex: Thomas42" maxlength="20" autocomplete="off"/>
    </div>
    <button id="btn-join" class="btn btn-green" style="width:100%;padding:14px;font-size:15px;">Rejoindre la Partie â†’</button>
    <div style="margin-top:18px;padding-top:18px;border-top:1px solid var(--border);">
      <button id="btn-toggle-admin" class="btn btn-ghost" style="width:100%;font-size:12px;">ğŸ” AccÃ¨s Professeur</button>
      <div id="admin-login-panel" style="display:none;margin-top:12px;">
        <label class="label">Code admin</label>
        <input id="inp-admin-code" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="margin-bottom:8px;"/>
        <p id="admin-err" style="color:var(--red);font-size:12px;margin-bottom:8px;display:none;">Code incorrect</p>
        <button id="btn-admin-login" class="btn btn-ghost" style="width:100%;">AccÃ©der Ã  la Console</button>
      </div>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WAITING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-waiting" class="screen" style="flex-direction:column;align-items:center;justify-content:center;position:relative;">
  <div class="grid-bg"></div>
  <div style="position:relative;z-index:10;text-align:center;padding:24px;width:100%;max-width:480px;">
    <div class="orbit-wrap">
      <div class="orbit-ring"></div>
      <div class="orbit-ring"></div>
      <div class="orbit-ring"></div>
      <div class="orbit-center">ğŸŒ</div>
    </div>
    <p style="color:var(--muted);font-size:11px;letter-spacing:2.5px;text-transform:uppercase;margin-bottom:6px;">Bienvenue</p>
    <h2 id="w-pseudo" style="font-size:32px;font-weight:800;margin-bottom:22px;"></h2>
    <div class="card" style="display:inline-block;min-width:190px;text-align:center;margin-bottom:22px;padding:20px 32px;">
      <div class="label" style="margin-bottom:8px;">Score total</div>
      <div id="w-score" style="font-size:54px;font-weight:800;font-family:'DM Mono',monospace;background:linear-gradient(135deg,var(--emerald),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;">0</div>
      <div style="color:var(--muted);font-size:12px;margin-top:4px;">points</div>
    </div>
    <p style="color:var(--muted);font-size:13px;animation:blink 2s ease-in-out infinite;margin-bottom:16px;">â³ En attente du professeurâ€¦</p>
    <div id="waiting-players" style="display:flex;gap:7px;flex-wrap:wrap;justify-content:center;max-width:400px;margin:0 auto;"></div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-game" class="screen">
  <div class="hud">
    <div class="score-pill">
      <span style="color:var(--muted);font-size:10px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:1px;">SCORE </span>
      <span id="hud-score">0</span>
    </div>
    <button id="btn-validate" disabled style="opacity:.45;cursor:not-allowed;">âœ“ Valider ma position</button>
  </div>
  <div id="pano-wrap"><div id="panorama" style="overflow-x:auto;overflow-y:hidden;scrollbar-width:none;-ms-overflow-style:none;"></div></div>
  <div id="map-wrap">
    <div id="game-map"></div>
    <div style="position:absolute;bottom:10px;left:10px;z-index:500;background:rgba(6,9,12,.88);border:1px solid var(--border2);border-radius:8px;padding:5px 11px;font-size:11px;color:var(--muted);pointer-events:none;backdrop-filter:blur(8px);">ğŸ“ Cliquez sur la carte pour placer votre hypothÃ¨se</div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULT OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="result-overlay">
  <div class="result-card">
    <div style="font-size:44px;margin-bottom:6px;">ğŸ¯</div>
    <div class="label" style="text-align:center;margin-bottom:4px;">Points gagnÃ©s</div>
    <div class="result-big" id="res-score">+0</div>
    <div class="progress-bar"><div class="progress-fill" id="res-bar" style="width:0%"></div></div>
    <div class="result-bar">
      <div style="text-align:center;">
        <div class="label" style="margin-bottom:4px;">Distance</div>
        <div id="res-dist" style="font-size:20px;font-weight:800;font-family:'DM Mono',monospace;color:var(--blue);"></div>
      </div>
      <div style="width:1px;background:var(--border);"></div>
      <div style="text-align:center;">
        <div class="label" style="margin-bottom:4px;">Total</div>
        <div id="res-total" style="font-size:20px;font-weight:800;font-family:'DM Mono',monospace;color:var(--emerald);"></div>
      </div>
    </div>
    <p style="color:var(--muted);font-size:12px;margin-top:4px;">Retour au lobby dans <span id="res-countdown">5</span>sâ€¦</p>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-admin" class="screen">

  <!-- Topbar -->
  <div class="admin-topbar">
    <div style="display:flex;align-items:center;gap:12px;min-width:0;">
      <div style="width:40px;height:40px;background:linear-gradient(135deg,var(--blue),#2563eb);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">ğŸ‘¨â€ğŸ«</div>
      <div style="min-width:0;">
        <div style="font-size:15px;font-weight:800;">Console Professeur</div>
        <div style="font-size:11px;color:var(--emerald);">ğŸŸ¢ geoguessrclasse â€” Firebase connectÃ©</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-shrink:0;">
      <button id="btn-reset-scores" class="btn btn-red" style="font-size:12px;padding:8px 14px;">ğŸ—‘ Reset scores</button>
      <button id="admin-back-btn" class="btn btn-ghost" style="font-size:12px;padding:8px 14px;">â† Quitter</button>
    </div>
  </div>

  <!-- Body -->
  <div class="admin-body">

    <!-- SIDEBAR -->
    <div class="admin-sidebar">
      <div class="section-title">ğŸ“š BibliothÃ¨que de lieux</div>
      <div class="diff-filter">
        <span class="tag tag-easy" onclick="filterPresets('easy')">Facile</span>
        <span class="tag tag-medium" onclick="filterPresets('medium')">Moyen</span>
        <span class="tag tag-hard" onclick="filterPresets('hard')">Difficile</span>
        <span class="tag tag-expert" onclick="filterPresets('expert')">Expert</span>
        <span class="tag tag-all" onclick="filterPresets('all')">Tous</span>
      </div>
      <div id="preset-list"></div>
    </div>

    <!-- MAIN -->
    <div class="admin-main">
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-num" id="stat-players" style="color:var(--blue);">0</div><div class="stat-lbl">Joueurs</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-rounds" style="color:var(--emerald);">0</div><div class="stat-lbl">Rounds</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-avg" style="color:var(--amber);">â€”</div><div class="stat-lbl">Moy. score</div></div>
      </div>

      <div class="tab-bar">
        <button class="tab active" onclick="switchTab('round')">ğŸš€ Round</button>
        <button class="tab" onclick="switchTab('leaderboard')">ğŸ† Classement</button>
        <button class="tab" onclick="switchTab('custom')">âœï¸ Perso</button>
      </div>

      <!-- ROUND TAB -->
      <div id="tab-round" class="tab-pane active">
        <div class="card">
          <div class="section-title">Lieu sÃ©lectionnÃ©</div>
          <div id="selected-preview" style="background:var(--surface2);border:1px dashed var(--border2);border-radius:10px;padding:20px;text-align:center;color:var(--muted);font-size:13px;margin-bottom:14px;">
            â† SÃ©lectionnez un lieu dans la bibliothÃ¨que Ã  gauche
          </div>
          <div style="display:flex;gap:10px;">
            <button id="admin-broadcast-btn" class="btn btn-green" style="flex:1;">ğŸ“¡ Diffuser ce Round</button>
            <button id="admin-stop-btn" class="btn btn-red" style="padding:11px 16px;" title="ArrÃªter le round">â¹</button>
          </div>
          <div id="round-status" style="margin-top:10px;font-size:12px;text-align:center;min-height:18px;"></div>
        </div>
      </div>

      <!-- LEADERBOARD TAB -->
      <div id="tab-leaderboard" class="tab-pane">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div class="section-title" style="margin:0;border:none;padding:0;">Classement temps rÃ©el</div>
            <span id="lb-count" style="font-size:11px;color:var(--muted);"></span>
          </div>
          <div id="admin-leaderboard"><p style="color:var(--muted);font-size:13px;text-align:center;padding:24px 0;">En attente des joueursâ€¦</p></div>
        </div>
      </div>

      <!-- CUSTOM TAB -->
      <div id="tab-custom" class="tab-pane">
        <div class="card">
          <div class="section-title">Lieu personnalisÃ©</div>
          <div style="margin-bottom:12px;">
            <label class="label">URL de l'image 360Â°</label>
            <input id="admin-image-url" class="input" type="url" placeholder="https://â€¦/panorama.jpg"/>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div><label class="label">Latitude</label><input id="admin-lat" class="input" type="number" step="0.0001" placeholder="48.8584"/></div>
            <div><label class="label">Longitude</label><input id="admin-lng" class="input" type="number" step="0.0001" placeholder="2.2945"/></div>
          </div>
          <div style="margin-bottom:14px;">
            <label class="label">Nom du lieu (optionnel)</label>
            <input id="admin-custom-name" class="input" type="text" placeholder="Ex: Mon lieu mystÃ¨re"/>
          </div>
          <button id="btn-custom-broadcast" class="btn btn-blue" style="width:100%;">ğŸ“¡ Diffuser ce lieu personnalisÃ©</button>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, collection, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBols3D4_fpOMAtbBgOcoAYy9ejpvCJr70",
  authDomain: "geoguessrclasse.firebaseapp.com",
  projectId: "geoguessrclasse",
  storageBucket: "geoguessrclasse.firebasestorage.app",
  messagingSenderId: "157640260530",
  appId: "1:157640260530:web:454fbf0c10fd001cc682ab"
};

const COL = `artifacts/${firebaseConfig.projectId}/public`;
const ADMIN_CODE = "PROF2024";

let db, auth, uid;
let map = null, viewer = null; // viewer unused (native image viewer)
let currentRound = null, guessLatLng = null, userMarker = null;
let totalScore = 0, roundsPlayed = 0;
let pseudo = "";
let roundUnsub = null, lbUnsub = null;
let selectedPreset = null;
let resultTimer = null;
let currentFilter = 'all';

// â”€â”€ PRESETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESETS = [
  // â”€â”€ FACILE â”€â”€
  {id:'f1',name:'Tour Eiffel',region:'Paris, France',flag:'ğŸ—¼',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Eiffelturm_Paris.jpg/1280px-Eiffelturm_Paris.jpg',lat:48.8584,lng:2.2945},
  {id:'f2',name:'Pyramides de Gizeh',region:'Ã‰gypte',flag:'ğŸ›ï¸',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/All_Gizah_Pyramids.jpg/2560px-All_Gizah_Pyramids.jpg',lat:29.9792,lng:31.1342},
  {id:'f3',name:'ColisÃ©e',region:'Rome, Italie',flag:'ğŸŸï¸',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Colosseo_2020.jpg/1280px-Colosseo_2020.jpg',lat:41.8902,lng:12.4922},
  {id:'f4',name:'Big Ben',region:'Londres, Royaume-Uni',flag:'ğŸ•°ï¸',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Clock_Tower_-_Palace_of_Westminster%2C_London_-_May_2007_icon.png/800px-Clock_Tower_-_Palace_of_Westminster%2C_London_-_May_2007_icon.png',lat:51.5007,lng:-0.1246},
  {id:'f5',name:'Taj Mahal',region:'Agra, Inde',flag:'ğŸ•Œ',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Taj_Mahal%2C_Agra%2C_India_edit3.jpg/1280px-Taj_Mahal%2C_Agra%2C_India_edit3.jpg',lat:27.1751,lng:78.0421},
  {id:'f6',name:'Mont Fuji',region:'Japon',flag:'ğŸ—»',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/2006_07_09_Fuji_from_Shinkansen.jpg/1280px-2006_07_09_Fuji_from_Shinkansen.jpg',lat:35.3606,lng:138.7274},
  {id:'f7',name:'Machu Picchu',region:'PÃ©rou',flag:'ğŸ”ï¸',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Machu_Picchu%2C_Peru.jpg/1280px-Machu_Picchu%2C_Peru.jpg',lat:-13.1631,lng:-72.5450},
  {id:'f8',name:'Statue de la LibertÃ©',region:'New York, USA',flag:'ğŸ—½',diff:'easy',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/New_york_times_square-terabass.jpg/1280px-New_york_times_square-terabass.jpg',lat:40.6892,lng:-74.0445},
  // â”€â”€ MOYEN â”€â”€
  {id:'m1',name:'OpÃ©ra de Sydney',region:'Australie',flag:'ğŸ­',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Sydney_NSW_2000%2C_Australia_-_panoramio%2815%29.jpg/1280px-Sydney_NSW_2000%2C_Australia_-_panoramio%2815%29.jpg',lat:-33.8568,lng:151.2153},
  {id:'m2',name:'Chichen Itza',region:'Mexique',flag:'ğŸ¯',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Chichen_Itza_3.jpg/1280px-Chichen_Itza_3.jpg',lat:20.6843,lng:-88.5678},
  {id:'m3',name:'Petra',region:'Jordanie',flag:'ğŸª¨',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Treasury_petra_crop.jpg/1280px-Treasury_petra_crop.jpg',lat:30.3285,lng:35.4444},
  {id:'m4',name:'Angkor Vat',region:'Cambodge',flag:'ğŸ›•',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/AngkorWat_02.jpg/1280px-AngkorWat_02.jpg',lat:13.4125,lng:103.8667},
  {id:'m5',name:'Uluru (Ayers Rock)',region:'Australie',flag:'ğŸ”´',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Uluru%2C_helicopter_view.jpg/1280px-Uluru%2C_helicopter_view.jpg',lat:-25.3444,lng:131.0369},
  {id:'m6',name:'Mont Saint-Michel',region:'Normandie, France',flag:'â›ª',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Mont_Saint_Michel_at_dusk_2007.jpg/1280px-Mont_Saint_Michel_at_dusk_2007.jpg',lat:48.6360,lng:-1.5115},
  {id:'m7',name:'Pamukkale',region:'Turquie',flag:'ğŸ¤',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Pamukkale_Hierapolis.jpg/1280px-Pamukkale_Hierapolis.jpg',lat:37.9137,lng:29.1188},
  {id:'m8',name:'Cappadoce',region:'Turquie',flag:'ğŸˆ',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Cappadocia_Goreme.jpg/1280px-Cappadocia_Goreme.jpg',lat:38.6431,lng:34.8289},
  {id:'m9',name:'Patagonie Torres del Paine',region:'Chili',flag:'ğŸ”ï¸',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Ruta_de_los_Parques_de_la_Patagonia.jpg/1280px-Ruta_de_los_Parques_de_la_Patagonia.jpg',lat:-50.9423,lng:-73.4068},
  {id:'m10',name:'Acropole d\'AthÃ¨nes',region:'GrÃ¨ce',flag:'ğŸ›ï¸',diff:'medium',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/The_Parthenon_in_Athens.jpg/1280px-The_Parthenon_in_Athens.jpg',lat:37.9715,lng:23.7267},
  // â”€â”€ DIFFICILE â”€â”€
  {id:'h1',name:'Lac BaÃ¯kal',region:'SibÃ©rie, Russie',flag:'ğŸ§Š',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Baikal_Listvianka_2.jpg/1280px-Baikal_Listvianka_2.jpg',lat:53.5587,lng:108.1650},
  {id:'h2',name:'Ãles FÃ©roÃ©',region:'Danemark',flag:'ğŸŒŠ',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/F%C3%A6r%C3%B8erne.jpg/1280px-F%C3%A6r%C3%B8erne.jpg',lat:61.8926,lng:-6.9118},
  {id:'h3',name:'Socotra',region:'YÃ©men',flag:'ğŸŒµ',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Socotra_dragon_tree.JPG/1280px-Socotra_dragon_tree.JPG',lat:12.4634,lng:53.8237},
  {id:'h4',name:'Delta de l\'Okavango',region:'Botswana',flag:'ğŸ˜',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f7/Okavango_Delta%2C_Botswana_%285%29.jpg/1280px-Okavango_Delta%2C_Botswana_%285%29.jpg',lat:-19.3173,lng:22.8582},
  {id:'h5',name:'VallÃ©e de la Mort',region:'Californie, USA',flag:'ğŸœï¸',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Death_Valley_National_Park%2C_Zabriskie_Point.jpg/1280px-Death_Valley_National_Park%2C_Zabriskie_Point.jpg',lat:36.5054,lng:-117.0794},
  {id:'h6',name:'Halong Bay',region:'Vietnam',flag:'â›µ',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Ha_Long_Bay_View.jpg/1280px-Ha_Long_Bay_View.jpg',lat:20.9101,lng:107.1839},
  {id:'h7',name:'Namib Desert',region:'Namibie',flag:'ğŸœï¸',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Sossusvlei_suicide_dune.jpg/1280px-Sossusvlei_suicide_dune.jpg',lat:-24.7277,lng:15.2952},
  {id:'h8',name:'Danakil Depression',region:'Ã‰thiopie',flag:'ğŸŒ‹',diff:'hard',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/DalolEthiopia.jpg/1280px-DalolEthiopia.jpg',lat:14.2417,lng:40.3000},
  // â”€â”€ EXPERT â”€â”€
  {id:'e1',name:'Ãle de PÃ¢ques',region:'Chili (Pacifique)',flag:'ğŸ—¿',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Moai_Rano_raraku.jpg/1280px-Moai_Rano_raraku.jpg',lat:-27.1127,lng:-109.3497},
  {id:'e2',name:'Salar d\'Uyuni',region:'Bolivie',flag:'ğŸª',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Salar_de_Uyuni_en_Bolivia.jpg/1280px-Salar_de_Uyuni_en_Bolivia.jpg',lat:-20.1338,lng:-67.4891},
  {id:'e3',name:'Svalbard',region:'NorvÃ¨ge (Arctique)',flag:'ğŸ»â€â„ï¸',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Pyramiden%2C_Svalbard.jpg/1280px-Pyramiden%2C_Svalbard.jpg',lat:78.2232,lng:15.6267},
  {id:'e4',name:'Kamtchatka',region:'Russie extrÃªme-orient',flag:'ğŸŒ‹',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Kronotsky_Zapovednik_05.jpg/1280px-Kronotsky_Zapovednik_05.jpg',lat:54.7500,lng:161.5000},
  {id:'e5',name:'Qobustan',region:'AzerbaÃ¯djan',flag:'ğŸª¨',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Rock_art_in_Gobustan.jpg/1280px-Rock_art_in_Gobustan.jpg',lat:40.0675,lng:49.3748},
  {id:'e6',name:'Jiuzhaigou',region:'Sichuan, Chine',flag:'ğŸŒˆ',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Jiuzhaigou_Valley_%28UN-UNESCO_protected%29.jpg/1280px-Jiuzhaigou_Valley_%28UN-UNESCO_protected%29.jpg',lat:33.2600,lng:103.9200},
  {id:'e7',name:'Atacama (Geysers)',region:'Chili',flag:'ğŸ’¨',diff:'expert',
   url:'https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Geiseres_del_Tatio.jpg/1280px-Geiseres_del_Tatio.jpg',lat:-22.3297,lng:-68.0103},
];

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);
signInAnonymously(auth).then(c=>{uid=c.user.uid;console.log('Auth OK',uid);}).catch(console.error);

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function haversine(a,b,c,d){const R=6371000,r=x=>x*Math.PI/180,dlat=r(c-a),dlng=r(d-b);const e=Math.sin(dlat/2)**2+Math.cos(r(a))*Math.cos(r(c))*Math.sin(dlng/2)**2;return R*2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));}
function calcScore(d){return Math.round(5000*Math.exp(-0.000002*d));}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMap(){
  if(map){map.remove();map=null;}
  map=L.map('game-map',{zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);
  map.setView([20,0],2);
  map.on('click',e=>{
    guessLatLng=e.latlng;
    if(userMarker)map.removeLayer(userMarker);
    userMarker=L.marker(e.latlng,{icon:L.divIcon({className:'',html:'<div style="width:16px;height:16px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 0 10px #10b98188;"></div>',iconAnchor:[8,8]})}).addTo(map);
    const b=document.getElementById('btn-validate');b.disabled=false;b.style.opacity='1';b.style.cursor='pointer';
  });
}

// â”€â”€ IMAGE VIEWER (drag panoramique) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPanorama(url){
  viewer = null;
  const wrap = document.getElementById('panorama');
  wrap.innerHTML = '';
  wrap.style.cssText = 'width:100%;height:100%;overflow:hidden;cursor:grab;position:relative;background:#06090c;';

  // Loading indicator
  wrap.innerHTML = '<div id="pano-loading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-size:14px;font-family:Syne,sans-serif;">â³ Chargementâ€¦</div>';

  const img = new Image();
  img.onload = () => {
    wrap.innerHTML = '';
    img.style.cssText = 'height:100%;width:auto;max-width:none;display:block;user-select:none;-webkit-user-drag:none;';
    wrap.appendChild(img);

    // Center image
    const centerX = (img.naturalWidth * (wrap.offsetHeight / img.naturalHeight) - wrap.offsetWidth) / 2;
    wrap.scrollLeft = centerX > 0 ? centerX : 0;

    // Drag to scroll
    let isDragging = false, startX = 0, scrollStart = 0;
    wrap.addEventListener('mousedown', e => {
      isDragging = true; startX = e.pageX; scrollStart = wrap.scrollLeft;
      wrap.style.cursor = 'grabbing'; e.preventDefault();
    });
    window.addEventListener('mousemove', e => {
      if(!isDragging) return;
      wrap.scrollLeft = scrollStart - (e.pageX - startX);
    });
    window.addEventListener('mouseup', () => { isDragging = false; wrap.style.cursor = 'grab'; });

    // Touch support
    let touchStartX = 0, touchScrollStart = 0;
    wrap.addEventListener('touchstart', e => { touchStartX = e.touches[0].pageX; touchScrollStart = wrap.scrollLeft; }, {passive:true});
    wrap.addEventListener('touchmove', e => { wrap.scrollLeft = touchScrollStart - (e.touches[0].pageX - touchStartX); }, {passive:true});
  };
  img.onerror = () => {
    wrap.innerHTML = '<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#ef4444;font-family:Syne,sans-serif;gap:8px;"><div style="font-size:32px;">âš ï¸</div><div style="font-size:14px;">Image inaccessible</div><div style="font-size:11px;color:#64748b;max-width:280px;text-align:center;">VÃ©rifiez l'URL dans la console admin</div></div>';
  };
  img.src = url;
}

// â”€â”€ LISTEN ROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function listenRound(){
  if(roundUnsub)roundUnsub();
  const ref=doc(db,COL,'activeRound');
  roundUnsub=onSnapshot(ref,snap=>{
    if(!snap.exists()||!snap.data().active){show('s-waiting');return;}
    const data=snap.data();
    if(!currentRound||currentRound.id!==data.id){currentRound=data;startRound(data);}
  });
}

function listenPlayers(){
  onSnapshot(collection(db,COL),snap=>{
    const names=[];let tot=0;
    snap.forEach(d=>{if(d.id.startsWith('lb_')){names.push(d.data().pseudo);tot+=d.data().totalScore||0;}});
    const el=document.getElementById('waiting-players');
    if(el)el.innerHTML=names.map(n=>`<div class="player-chip">${n}</div>`).join('');
    const sp=document.getElementById('stat-players');if(sp)sp.textContent=names.length;
    const sa=document.getElementById('stat-avg');if(sa&&names.length)sa.textContent=Math.round(tot/names.length).toLocaleString();
  });
}

function startRound(data){
  show('s-game');
  guessLatLng=null;
  if(userMarker&&map){map.removeLayer(userMarker);userMarker=null;}
  const b=document.getElementById('btn-validate');b.disabled=true;b.style.opacity='.45';b.style.cursor='not-allowed';
  document.getElementById('hud-score').textContent=totalScore.toLocaleString();
  setTimeout(()=>{initMap();loadPanorama(data.imageUrl);},150);
}

// â”€â”€ VALIDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function validateGuess(){
  if(!guessLatLng||!currentRound)return;
  const dist=haversine(guessLatLng.lat,guessLatLng.lng,currentRound.targetLat,currentRound.targetLng);
  const score=calcScore(dist);
  totalScore+=score;roundsPlayed++;
  const tgt=L.latLng(currentRound.targetLat,currentRound.targetLng);
  L.polyline([guessLatLng,tgt],{color:'#3b82f6',weight:2,dashArray:'7 4',opacity:.9}).addTo(map);
  L.marker(tgt,{icon:L.divIcon({className:'',html:'<div style="width:18px;height:18px;background:#ef4444;border:3px solid #fff;border-radius:50%;box-shadow:0 0 12px #ef444488;"></div>',iconAnchor:[9,9]})}).addTo(map);
  map.fitBounds([guessLatLng,tgt],{padding:[50,50]});
  try{await setDoc(doc(db,COL,`lb_${uid}`),{pseudo,totalScore,lastScore:score,rounds:roundsPlayed,ts:Date.now()});}catch(e){console.error(e);}
  showResult(score,dist);
}

function showResult(score,dist){
  const km=dist<1000?`${Math.round(dist)} m`:`${(dist/1000).toFixed(1)} km`;
  document.getElementById('res-score').textContent=`+${score.toLocaleString()}`;
  document.getElementById('res-dist').textContent=km;
  document.getElementById('res-total').textContent=totalScore.toLocaleString();
  document.getElementById('res-bar').style.width=`${Math.round((score/5000)*100)}%`;
  document.getElementById('w-score').textContent=totalScore.toLocaleString();
  const ov=document.getElementById('result-overlay');ov.classList.add('show');
  let cd=5;document.getElementById('res-countdown').textContent=cd;
  if(resultTimer)clearInterval(resultTimer);
  resultTimer=setInterval(()=>{cd--;document.getElementById('res-countdown').textContent=cd;if(cd<=0){clearInterval(resultTimer);ov.classList.remove('show');currentRound=null;show('s-waiting');}},1000);
}

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function broadcastPreset(p){
  const id=`round_${Date.now()}`;
  await setDoc(doc(db,COL,'activeRound'),{id,imageUrl:p.url,targetLat:p.lat,targetLng:p.lng,name:p.name,active:true,startedAt:Date.now()});
  const sr=document.getElementById('round-status');if(sr)sr.innerHTML=`<span style="color:var(--emerald)">âœ“ En cours : ${p.name}</span>`;
  const st=document.getElementById('stat-rounds');if(st)st.textContent=parseInt(st.textContent||0)+1;
}

async function stopRound(){
  await setDoc(doc(db,COL,'activeRound'),{active:false});
  const sr=document.getElementById('round-status');if(sr)sr.innerHTML=`<span style="color:var(--muted)">Round arrÃªtÃ©.</span>`;
}

async function resetScores(){
  if(!confirm('Remettre TOUS les scores Ã  zÃ©ro ? IrrÃ©versible.'))return;
  const snap=await getDocs(collection(db,COL));
  const batch=writeBatch(db);
  snap.forEach(d=>{if(d.id.startsWith('lb_')||d.id.startsWith('score_'))batch.delete(d.ref);});
  await batch.commit();
  alert('Scores remis Ã  zÃ©ro.');
}

function listenLeaderboard(){
  if(lbUnsub)lbUnsub();
  lbUnsub=onSnapshot(collection(db,COL),snap=>{
    const players=[];let tot=0;
    snap.forEach(d=>{if(d.id.startsWith('lb_')){const x=d.data();players.push(x);tot+=x.totalScore||0;}});
    players.sort((a,b)=>b.totalScore-a.totalScore);
    const el=document.getElementById('admin-leaderboard');
    const lbc=document.getElementById('lb-count');if(lbc)lbc.textContent=players.length+' joueur'+(players.length>1?'s':'');
    const sp=document.getElementById('stat-players');if(sp)sp.textContent=players.length;
    const sa=document.getElementById('stat-avg');if(sa&&players.length)sa.textContent=Math.round(tot/players.length).toLocaleString();
    if(!el)return;
    if(!players.length){el.innerHTML='<p style="color:var(--muted);font-size:13px;text-align:center;padding:24px 0;">Aucun joueurâ€¦</p>';return;}
    el.innerHTML=players.slice(0,30).map((p,i)=>{
      const cls=i===0?'lb-gold':i===1?'lb-silver':i===2?'lb-bronze':'lb-normal';
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`<span style="color:var(--muted);font-size:12px;width:22px;text-align:center;display:inline-block;">${i+1}</span>`;
      return `<div class="lb-row ${cls}"><div style="display:flex;align-items:center;gap:9px;">${medal}<span style="font-weight:700;">${p.pseudo}</span>${p.rounds?`<span style="font-size:10px;color:var(--muted);">${p.rounds}r</span>`:''}</div><div class="mono-score">${(p.totalScore||0).toLocaleString()}</div></div>`;
    }).join('');
  });
}

// â”€â”€ PRESETS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.filterPresets=function(diff){
  currentFilter=diff;renderPresets();
};
window.selectPreset=function(id){
  selectedPreset=PRESETS.find(p=>p.id===id);
  renderPresets();
  const diffLabel={easy:'Facile',medium:'Moyen',hard:'Difficile',expert:'Expert'};
  const el=document.getElementById('selected-preview');
  if(el)el.innerHTML=`<div style="display:flex;align-items:center;gap:14px;text-align:left;"><span style="font-size:36px;">${selectedPreset.flag}</span><div><div style="font-size:15px;font-weight:800;margin-bottom:3px;">${selectedPreset.name}</div><div style="color:var(--muted);font-size:12px;margin-bottom:6px;">${selectedPreset.region}</div><span class="tag tag-${selectedPreset.diff}">${diffLabel[selectedPreset.diff]}</span></div></div>`;
  switchTab('round');
};
window.switchTab=function(name){
  document.querySelectorAll('.tab').forEach((t,i)=>{t.classList.toggle('active',['round','leaderboard','custom'][i]===name);});
  document.querySelectorAll('.tab-pane').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
};

function renderPresets(){
  const list=PRESETS.filter(p=>currentFilter==='all'||p.diff===currentFilter);
  const el=document.getElementById('preset-list');
  if(!el)return;
  const diffLabel={easy:'Facile',medium:'Moyen',hard:'Difficile',expert:'Expert'};
  el.innerHTML=list.map(p=>`
    <button class="preset-btn${selectedPreset?.id===p.id?' selected':''}" onclick="selectPreset('${p.id}')">
      <span style="font-size:18px;">${p.flag}</span>
      <div class="preset-info">
        <div class="preset-name">${p.name}</div>
        <div class="preset-region">${p.region}</div>
      </div>
      <span class="tag tag-${p.diff}" style="flex-shrink:0;">${diffLabel[p.diff]}</span>
    </button>`).join('');
}

// â”€â”€ DOM READY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  renderPresets();

  document.getElementById('btn-join').addEventListener('click',()=>{
    pseudo=document.getElementById('inp-pseudo').value.trim();
    if(!pseudo){document.getElementById('inp-pseudo').style.borderColor='var(--red)';return;}
    document.getElementById('w-pseudo').textContent=pseudo;
    document.getElementById('w-score').textContent='0';
    show('s-waiting');
    listenRound();
    listenPlayers();
  });

  document.getElementById('inp-pseudo').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('btn-join').click();});

  document.getElementById('btn-toggle-admin').addEventListener('click',()=>{
    const p=document.getElementById('admin-login-panel');
    p.style.display=p.style.display==='none'?'block':'none';
  });

  document.getElementById('btn-admin-login').addEventListener('click',()=>{
    if(document.getElementById('inp-admin-code').value===ADMIN_CODE){
      show('s-admin');renderPresets();listenLeaderboard();listenPlayers();
    } else {
      document.getElementById('admin-err').style.display='block';
    }
  });

  document.getElementById('inp-admin-code').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('btn-admin-login').click();});

  document.getElementById('admin-back-btn').addEventListener('click',()=>{
    if(lbUnsub){lbUnsub();lbUnsub=null;}
    show('s-welcome');
  });

  document.getElementById('btn-validate').addEventListener('click',validateGuess);

  document.getElementById('admin-broadcast-btn').addEventListener('click',()=>{
    if(!selectedPreset){alert('SÃ©lectionnez d\'abord un lieu dans la bibliothÃ¨que.');return;}
    broadcastPreset(selectedPreset);
  });

  document.getElementById('admin-stop-btn').addEventListener('click',stopRound);

  document.getElementById('btn-custom-broadcast').addEventListener('click',()=>{
    const url=document.getElementById('admin-image-url').value.trim();
    const lat=parseFloat(document.getElementById('admin-lat').value);
    const lng=parseFloat(document.getElementById('admin-lng').value);
    const name=document.getElementById('admin-custom-name').value.trim()||'Lieu mystÃ¨re';
    if(!url||isNaN(lat)||isNaN(lng)){alert('Remplissez l\'URL et les coordonnÃ©es.');return;}
    broadcastPreset({url,lat,lng,name,flag:'ğŸ“',diff:'medium'});
  });

  document.getElementById('btn-reset-scores').addEventListener('click',resetScores);
});
</script>
</body>
</html>
