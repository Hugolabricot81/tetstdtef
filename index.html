<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©oClasse ‚Äî G√©ographie Multijoueur</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://unpkg.com/panolens@0.12.1/build/panolens.min.js"></script>

  <style>
    :root {
      --bg: #06090c;
      --surface: #0e1419;
      --surface2: #161e26;
      --surface3: #1d2733;
      --border: #1e2d3d;
      --border2: #253545;
      --emerald: #10b981;
      --emerald-dim: #064e3b;
      --emerald-glow: #10b98133;
      --blue: #3b82f6;
      --amber: #f59e0b;
      --red: #ef4444;
      --text: #e2e8f0;
      --muted: #64748b;
      --muted2: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    .screen {
      display: none;
      width: 100%;
      height: 100vh;
      position: relative;
    }

    .screen.active {
      display: flex;
    }

    .grid-bg {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.07;
      animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes chipIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .card {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: fadeUp 0.6s ease;
    }

    .logo {
      font-size: 64px;
      animation: pulse 2s ease-in-out infinite;
      display: inline-block;
      margin-bottom: 16px;
    }

    .title {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--emerald), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--muted2);
      font-size: 18px;
      margin-bottom: 32px;
    }

    input {
      width: 100%;
      padding: 16px 20px;
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      outline: none;
      transition: all 0.3s;
      margin-bottom: 16px;
    }

    input:focus {
      border-color: var(--emerald);
      box-shadow: 0 0 0 4px var(--emerald-glow);
    }

    .btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--emerald), #059669);
      color: white;
      box-shadow: 0 0 20px var(--emerald-glow);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 30px var(--emerald-glow);
    }

    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      margin-top: 12px;
    }

    .btn-secondary:hover {
      background: var(--surface3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error {
      color: var(--red);
      font-size: 14px;
      margin-top: 8px;
      animation: fadeUp 0.3s ease;
    }

    #s-welcome {
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #welcomeCard {
      width: 90%;
      max-width: 480px;
      text-align: center;
    }

    #adminAccess {
      display: none;
      margin-top: 16px;
      animation: fadeUp 0.3s ease;
    }

    #s-waiting {
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .orbit-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin-bottom: 32px;
    }

    .orbit {
      position: absolute;
      inset: 0;
      border: 2px solid var(--border2);
      border-radius: 50%;
      animation: spin 3s linear infinite;
    }

    .orbit:nth-child(2) {
      animation-duration: 4s;
      animation-direction: reverse;
      inset: 20px;
    }

    .orbit-center {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .player-name {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .score-display {
      font-family: 'DM Mono', monospace;
      font-size: 48px;
      font-weight: 500;
      color: var(--emerald);
      margin-bottom: 24px;
    }

    .waiting-text {
      color: var(--muted2);
      font-size: 18px;
      margin-bottom: 32px;
      animation: blink 2s ease-in-out infinite;
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      max-width: 600px;
    }

    .player-chip {
      padding: 8px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      animation: chipIn 0.4s ease;
    }

    #s-game {
      flex-direction: column;
    }

    #panoContainer {
      width: 100%;
      height: 60vh;
      position: relative;
      background: var(--surface);
    }

    #panoLoading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      z-index: 10;
      font-size: 18px;
      color: var(--muted);
    }

    #panoError {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: var(--surface);
      z-index: 10;
      padding: 20px;
      text-align: center;
    }

    #panoError .error-title {
      font-size: 24px;
      color: var(--red);
      margin-bottom: 12px;
    }

    #panoError .error-url {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
      max-width: 80%;
    }

    #mapContainer {
      width: 100%;
      height: 40vh;
      position: relative;
    }

    .game-hud {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      gap: 12px;
    }

    .hud-pill {
      padding: 12px 20px;
      background: var(--surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      font-weight: 500;
      color: var(--emerald);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .validate-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--emerald), #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 20px var(--emerald-glow);
      transition: all 0.3s;
    }

    .validate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 30px var(--emerald-glow);
    }

    .validate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .result-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6, 9, 12, 0.95);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeUp 0.5s ease;
    }

    .result-overlay.active {
      display: flex;
    }

    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px;
      text-align: center;
      max-width: 500px;
      width: 90%;
    }

    .result-score {
      font-family: 'DM Mono', monospace;
      font-size: 72px;
      font-weight: 500;
      background: linear-gradient(135deg, var(--emerald), #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
    }

    .result-label {
      color: var(--muted2);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 24px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--surface2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), #059669);
      transition: width 1s ease;
    }

    .result-details {
      display: flex;
      justify-content: space-around;
      margin-bottom: 24px;
    }

    .result-detail {
      text-align: center;
    }

    .result-detail-value {
      font-family: 'DM Mono', monospace;
      font-size: 24px;
      color: var(--text);
      margin-bottom: 4px;
    }

    .result-detail-label {
      color: var(--muted);
      font-size: 12px;
    }

    .countdown {
      color: var(--muted2);
      font-size: 14px;
    }

    #s-admin {
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #s-admin.active {
      display: flex;
    }

    .admin-topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-shrink: 0;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
    }

    .firebase-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface2);
      border-radius: 20px;
      font-size: 14px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--emerald);
      animation: pulse 2s ease-in-out infinite;
    }

    .admin-actions {
      display: flex;
      gap: 12px;
    }

    .btn-small {
      padding: 10px 20px;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-small:hover {
      background: var(--surface3);
    }

    .btn-small.danger {
      color: var(--red);
      border-color: var(--red);
    }

    .btn-small.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .admin-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .admin-sidebar {
      width: 300px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    .difficulty-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .diff-tag {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .diff-tag.easy { background: rgba(16, 185, 129, 0.2); color: var(--emerald); }
    .diff-tag.medium { background: rgba(245, 158, 11, 0.2); color: var(--amber); }
    .diff-tag.hard { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .diff-tag.expert { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .diff-tag.all { background: var(--surface2); color: var(--muted2); }

    .diff-tag.active {
      border-color: currentColor;
    }

    .presets-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .preset-btn {
      padding: 12px 16px;
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      transition: all 0.3s;
    }

    .preset-btn:hover {
      background: var(--surface3);
      border-color: var(--border2);
    }

    .preset-btn.selected {
      border-color: var(--emerald);
      background: rgba(16, 185, 129, 0.1);
    }

    .preset-name {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preset-region {
      font-size: 12px;
      color: var(--muted);
    }

    .admin-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .admin-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      color: var(--muted2);
      border: none;
      border-radius: 8px;
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: var(--surface2);
      color: var(--emerald);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-value {
      font-family: 'DM Mono', monospace;
      font-size: 32px;
      font-weight: 500;
      color: var(--emerald);
      margin-bottom: 4px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 14px;
    }

    .leaderboard {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      animation: fadeUp 0.3s ease;
    }

    .leaderboard-rank {
      font-family: 'DM Mono', monospace;
      font-size: 20px;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
    }

    .leaderboard-medal {
      font-size: 24px;
      min-width: 40px;
      text-align: center;
    }

    .leaderboard-info {
      flex: 1;
    }

    .leaderboard-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .leaderboard-rounds {
      font-size: 12px;
      color: var(--muted);
    }

    .leaderboard-score {
      font-family: 'DM Mono', monospace;
      font-size: 24px;
      font-weight: 500;
      color: var(--emerald);
    }

    .round-preview {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .preview-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .preview-details {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--muted2);
    }

    .current-round-status {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .status-active {
      color: var(--emerald);
      font-weight: 600;
    }

    .status-inactive {
      color: var(--muted);
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .admin-main {
        flex-direction: column;
      }

      .admin-sidebar {
        width: 100%;
        max-height: 300px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      #s-game {
        flex-direction: row;
      }

      #panoContainer {
        width: 50%;
        height: 100vh;
      }

      #mapContainer {
        width: 50%;
        height: 100vh;
      }
    }
  </style>
  <meta property="og:image" content="https://bolt.new/static/og_default.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://bolt.new/static/og_default.png">
</head>
<body>

  <div id="s-welcome" class="screen active">
    <div class="grid-bg"></div>
    <div class="card" id="welcomeCard">
      <div class="logo">üåç</div>
      <h1 class="title">G√©oClasse</h1>
      <p class="subtitle">G√©ographie Multijoueur en Temps R√©el</p>
      <input type="text" id="pseudoInput" placeholder="Entrez votre pseudo" maxlength="20" />
      <button class="btn btn-primary" id="joinBtn">Rejoindre la Partie ‚Üí</button>
      <button class="btn btn-secondary" id="adminToggle">üîê Acc√®s Professeur</button>
      <div id="adminAccess">
        <input type="password" id="adminPassword" placeholder="Code professeur" />
        <button class="btn btn-primary" id="adminLoginBtn">Connexion</button>
        <div class="error" id="adminError" style="display:none"></div>
      </div>
      <div class="error" id="welcomeError" style="display:none"></div>
    </div>
  </div>

  <div id="s-waiting" class="screen">
    <div class="grid-bg"></div>
    <div class="orbit-container">
      <div class="orbit"></div>
      <div class="orbit"></div>
      <div class="orbit-center">üåç</div>
    </div>
    <div class="player-name" id="waitingPseudo"></div>
    <div class="score-display" id="waitingScore">0 pts</div>
    <div class="waiting-text">‚è≥ En attente du professeur‚Ä¶</div>
    <div class="players-list" id="playersList"></div>
  </div>

  <div id="s-game" class="screen">
    <div id="panoContainer">
      <div id="panoLoading">Chargement de l'image 360¬∞...</div>
      <div id="panoError">
        <div class="error-title">‚ùå Impossible de charger l'image</div>
        <div class="error-url" id="errorUrl"></div>
      </div>
    </div>
    <div id="mapContainer">
      <div class="game-hud">
        <div class="hud-pill" id="gameScore">0 pts</div>
      </div>
      <button class="validate-btn" id="validateBtn" disabled>‚úì Valider</button>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card">
      <div class="result-score" id="resultScore">0</div>
      <div class="result-label">Points gagn√©s</div>
      <div class="progress-bar">
        <div class="progress-fill" id="resultProgress"></div>
      </div>
      <div class="result-details">
        <div class="result-detail">
          <div class="result-detail-value" id="resultDistance">0 km</div>
          <div class="result-detail-label">Distance</div>
        </div>
        <div class="result-detail">
          <div class="result-detail-value" id="resultTotal">0</div>
          <div class="result-detail-label">Score Total</div>
        </div>
      </div>
      <div class="countdown" id="resultCountdown">Retour dans 5s...</div>
    </div>
  </div>

  <div id="s-admin" class="screen">
    <div class="admin-topbar">
      <div class="admin-logo">
        <span>üåç</span>
        <span>Console Professeur</span>
      </div>
      <div class="firebase-status">
        <div class="status-dot"></div>
        <span>Firebase connect√©</span>
      </div>
      <div class="admin-actions">
        <button class="btn-small danger" id="resetScoresBtn">üóë Reset Scores</button>
        <button class="btn-small" id="stopRoundBtn">Stop Round</button>
      </div>
    </div>

    <div class="admin-main">
      <div class="admin-sidebar">
        <div class="sidebar-title">üìö Biblioth√®que</div>
        <div class="difficulty-filters">
          <div class="diff-tag all active" data-diff="all">Tous</div>
          <div class="diff-tag easy" data-diff="easy">Facile</div>
          <div class="diff-tag medium" data-diff="medium">Moyen</div>
          <div class="diff-tag hard" data-diff="hard">Difficile</div>
          <div class="diff-tag expert" data-diff="expert">Expert</div>
        </div>
        <div class="presets-list" id="presetsList"></div>
      </div>

      <div class="admin-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statPlayers">0</div>
            <div class="stat-label">Joueurs connect√©s</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statRounds">0</div>
            <div class="stat-label">Rounds diffus√©s</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAvgScore">0</div>
            <div class="stat-label">Score moyen</div>
          </div>
        </div>

        <div class="admin-tabs">
          <button class="tab-btn active" data-tab="round">üöÄ Round</button>
          <button class="tab-btn" data-tab="leaderboard">üèÜ Classement</button>
          <button class="tab-btn" data-tab="custom">‚úèÔ∏è Personnalis√©</button>
        </div>

        <div class="tab-content active" id="tab-round">
          <div class="round-preview" id="roundPreview">
            <div class="preview-title">Aucun lieu s√©lectionn√©</div>
            <p style="color: var(--muted)">S√©lectionnez un lieu dans la biblioth√®que</p>
          </div>
          <button class="btn btn-primary" id="broadcastBtn" disabled>üì° Diffuser ce Round</button>
          <div class="current-round-status" id="roundStatus">
            <div class="status-inactive">Aucun round actif</div>
          </div>
        </div>

        <div class="tab-content" id="tab-leaderboard">
          <div class="leaderboard" id="leaderboard"></div>
        </div>

        <div class="tab-content" id="tab-custom">
          <div class="form-group">
            <label class="form-label">URL Image 360¬∞</label>
            <input type="text" id="customUrl" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label class="form-label">Latitude</label>
            <input type="number" id="customLat" step="any" placeholder="48.8584" />
          </div>
          <div class="form-group">
            <label class="form-label">Longitude</label>
            <input type="number" id="customLng" step="any" placeholder="2.2945" />
          </div>
          <div class="form-group">
            <label class="form-label">Nom du lieu</label>
            <input type="text" id="customName" placeholder="Tour Eiffel" />
          </div>
          <button class="btn btn-primary" id="broadcastCustomBtn">üì° Diffuser</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBols3D4_fpOMAtbBgOcoAYy9ejpvCJr70",
      authDomain: "geoguessrclasse.firebaseapp.com",
      projectId: "geoguessrclasse",
      storageBucket: "geoguessrclasse.firebasestorage.app",
      messagingSenderId: "157640260530",
      appId: "1:157640260530:web:454fbf0c10fd001cc682ab"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const PRESETS = [
      {id:'tour-eiffel',name:'Tour Eiffel',region:'Paris, France',flag:'üá´üá∑',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/tour-eiffel.jpg',lat:48.8584,lng:2.2945},
      {id:'pyramides',name:'Pyramides de Gizeh',region:'Le Caire, √âgypte',flag:'üá™üá¨',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/pyramides.jpg',lat:29.9792,lng:31.1342},
      {id:'colisee',name:'Colis√©e',region:'Rome, Italie',flag:'üáÆüáπ',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/colisee.jpg',lat:41.8902,lng:12.4922},
      {id:'taj-mahal',name:'Taj Mahal',region:'Agra, Inde',flag:'üáÆüá≥',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/taj-mahal.jpg',lat:27.1751,lng:78.0421},
      {id:'big-ben',name:'Big Ben',region:'Londres, Royaume-Uni',flag:'üá¨üáß',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/big-ben.jpg',lat:51.5007,lng:-0.1246},
      {id:'mont-fuji',name:'Mont Fuji',region:'Japon',flag:'üáØüáµ',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/fuji.jpg',lat:35.3606,lng:138.7274},
      {id:'machu-picchu',name:'Machu Picchu',region:'P√©rou',flag:'üáµüá™',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/machu-picchu.jpg',lat:-13.1631,lng:-72.5450},
      {id:'statue-liberte',name:'Statue de la Libert√©',region:'New York, USA',flag:'üá∫üá∏',diff:'easy',url:'https://hugolabricot81.github.io/testrgf/liberte.jpg',lat:40.6892,lng:-74.0445},
      {id:'opera-sydney',name:'Op√©ra de Sydney',region:'Sydney, Australie',flag:'üá¶üá∫',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/opera-sydney.jpg',lat:-33.8568,lng:151.2153},
      {id:'petra',name:'P√©tra',region:'Jordanie',flag:'üáØüá¥',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/petra.jpg',lat:30.3285,lng:35.4444},
      {id:'angkor',name:'Angkor Vat',region:'Cambodge',flag:'üá∞üá≠',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/angkor.jpg',lat:13.4125,lng:103.8670},
      {id:'cappadoce',name:'Cappadoce',region:'Turquie',flag:'üáπüá∑',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/cappadoce.jpg',lat:38.6431,lng:34.8286},
      {id:'santorini',name:'Santorin',region:'Gr√®ce',flag:'üá¨üá∑',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/santorini.jpg',lat:36.3932,lng:25.4615},
      {id:'fjords',name:'Fjords norv√©giens',region:'Norv√®ge',flag:'üá≥üá¥',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/fjords.jpg',lat:61.0900,lng:6.8390},
      {id:'sagrada',name:'Sagrada Familia',region:'Barcelone, Espagne',flag:'üá™üá∏',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/sagrada.jpg',lat:41.4036,lng:2.1744},
      {id:'neuschwanstein',name:'Ch√¢teau Neuschwanstein',region:'Bavi√®re, Allemagne',flag:'üá©üá™',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/neuschwanstein.jpg',lat:47.5576,lng:10.7498},
      {id:'feroe',name:'√éles F√©ro√©',region:'Danemark',flag:'üá´üá¥',diff:'hard',url:'https://hugolabricot81.github.io/testrgf/feroe.jpg',lat:62.0079,lng:-6.7900},
      {id:'baikal',name:'Lac Ba√Økal',region:'Russie',flag:'üá∑üá∫',diff:'hard',url:'https://hugolabricot81.github.io/testrgf/baikal.jpg',lat:53.5587,lng:108.1650},
      {id:'wadi-rum',name:'Wadi Rum',region:'Jordanie',flag:'üáØüá¥',diff:'hard',url:'https://hugolabricot81.github.io/testrgf/wadi-rum.jpg',lat:29.5764,lng:35.4207},
      {id:'socotra',name:'√éle de Socotra',region:'Y√©men',flag:'üáæüá™',diff:'hard',url:'https://hugolabricot81.github.io/testrgf/socotra.jpg',lat:12.5000,lng:53.8333},
      {id:'namib',name:'D√©sert du Namib',region:'Namibie',flag:'üá≥üá¶',diff:'hard',url:'https://hugolabricot81.github.io/testrgf/namib.jpg',lat:-24.7560,lng:15.2830},
      {id:'paques',name:'√éle de P√¢ques',region:'Chili',flag:'üá®üá±',diff:'expert',url:'https://hugolabricot81.github.io/testrgf/paques.jpg',lat:-27.1127,lng:-109.3497},
      {id:'uyuni',name:'Salar d\'Uyuni',region:'Bolivie',flag:'üáßüá¥',diff:'expert',url:'https://hugolabricot81.github.io/testrgf/uyuni.jpg',lat:-20.3079,lng:-66.8250},
      {id:'svalbard',name:'Svalbard',region:'Norv√®ge',flag:'üá≥üá¥',diff:'expert',url:'https://hugolabricot81.github.io/testrgf/svalbard.jpg',lat:78.2232,lng:15.6267},
      {id:'kamtchatka',name:'Kamtchatka',region:'Russie',flag:'üá∑üá∫',diff:'expert',url:'https://hugolabricot81.github.io/testrgf/kamtchatka.jpg',lat:56.0000,lng:160.0000},
      {id:'zhangjiajie',name:'Zhangjiajie',region:'Chine',flag:'üá®üá≥',diff:'medium',url:'https://hugolabricot81.github.io/testrgf/zhangjiajie.jpg',lat:29.1167,lng:110.4792}
    ];

    let currentUser = null;
    let currentPseudo = '';
    let totalScore = 0;
    let roundsPlayed = 0;
    let currentRound = null;
    let guessMarker = null;
    let targetMarker = null;
    let guessLine = null;
    let map = null;
    let viewer = null;
    let selectedPreset = null;
    let currentFilter = 'all';

    function show(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function saveScore(score, distance) {
      if (!currentUser) return;
      totalScore += score;
      roundsPlayed++;
      const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', `lb_${currentUser.uid}`);
      await setDoc(docRef, {
        pseudo: currentPseudo,
        totalScore: totalScore,
        lastScore: score,
        rounds: roundsPlayed,
        ts: Date.now()
      });
    }

    async function loadUserScore() {
      if (!currentUser) return;
      const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', `lb_${currentUser.uid}`);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        totalScore = data.totalScore || 0;
        roundsPlayed = data.rounds || 0;
      }
    }

    document.getElementById('adminToggle').addEventListener('click', () => {
      const access = document.getElementById('adminAccess');
      access.style.display = access.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('adminLoginBtn').addEventListener('click', () => {
      const password = document.getElementById('adminPassword').value;
      const errorEl = document.getElementById('adminError');
      if (password === 'PROF2024') {
        window.location.search = '?admin';
      } else {
        errorEl.textContent = 'Code incorrect';
        errorEl.style.display = 'block';
      }
    });

    document.getElementById('pseudoInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('joinBtn').click();
      }
    });

    document.getElementById('joinBtn').addEventListener('click', async () => {
      const pseudo = document.getElementById('pseudoInput').value.trim();
      const errorEl = document.getElementById('welcomeError');

      if (!pseudo) {
        errorEl.textContent = 'Pseudo requis';
        errorEl.style.display = 'block';
        return;
      }

      if (pseudo.length > 20) {
        errorEl.textContent = 'Pseudo trop long (max 20 caract√®res)';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const userCredential = await signInAnonymously(auth);
        currentUser = userCredential.user;
        currentPseudo = pseudo;
        await loadUserScore();

        document.getElementById('waitingPseudo').textContent = pseudo;
        document.getElementById('waitingScore').textContent = `${totalScore} pts`;
        document.getElementById('gameScore').textContent = `${totalScore} pts`;

        show('s-waiting');
        listenActiveRound();
        listenPlayers();
      } catch (error) {
        errorEl.textContent = 'Erreur de connexion';
        errorEl.style.display = 'block';
      }
    });

    function listenActiveRound() {
      const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', 'activeRound');
      onSnapshot(docRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.data();
          if (data.active) {
            currentRound = data;
            startGame();
          }
        }
      });
    }

    function listenPlayers() {
      const colRef = collection(db, 'artifacts', 'geoguessrclasse', 'public');
      onSnapshot(colRef, (snapshot) => {
        const players = [];
        snapshot.forEach((doc) => {
          if (doc.id.startsWith('lb_') && doc.id !== `lb_${currentUser?.uid}`) {
            players.push(doc.data());
          }
        });

        const listEl = document.getElementById('playersList');
        listEl.innerHTML = players.map(p =>
          `<div class="player-chip">${p.pseudo}</div>`
        ).join('');
      });
    }

    function startGame() {
      show('s-game');
      initPanorama();
      if (!map) initMap();
      resetMap();
      document.getElementById('validateBtn').disabled = true;
    }

    function initPanorama() {
      if (viewer) {
        try {
          viewer.dispose();
        } catch (e) {}
        viewer = null;
      }

      const container = document.getElementById('panoContainer');
      const loading = document.getElementById('panoLoading');
      const error = document.getElementById('panoError');

      loading.style.display = 'flex';
      error.style.display = 'none';

      setTimeout(() => {
        try {
          const panorama = new PANOLENS.ImagePanorama(currentRound.imageUrl);
          viewer = new PANOLENS.Viewer({
            container: container,
            controlBar: false,
            autoRotate: false,
            cameraFov: 90
          });

          panorama.addEventListener('load', () => {
            loading.style.display = 'none';
          });

          panorama.addEventListener('error', () => {
            loading.style.display = 'none';
            error.style.display = 'flex';
            document.getElementById('errorUrl').textContent = currentRound.imageUrl;
          });

          viewer.add(panorama);
        } catch (e) {
          loading.style.display = 'none';
          error.style.display = 'flex';
          document.getElementById('errorUrl').textContent = currentRound.imageUrl;
        }
      }, 100);
    }

    function initMap() {
      map = L.map('mapContainer', {
        attributionControl: false,
        zoomControl: true
      }).setView([20, 0], 2);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
      }).addTo(map);

      map.on('click', (e) => {
        if (guessMarker) {
          map.removeLayer(guessMarker);
        }
        guessMarker = L.marker(e.latlng, {
          icon: L.divIcon({
            className: 'guess-marker',
            html: '<div style="width:20px;height:20px;background:#10b981;border:3px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,0.5)"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(map);
        document.getElementById('validateBtn').disabled = false;
      });
    }

    function resetMap() {
      if (guessMarker) {
        map.removeLayer(guessMarker);
        guessMarker = null;
      }
      if (targetMarker) {
        map.removeLayer(targetMarker);
        targetMarker = null;
      }
      if (guessLine) {
        map.removeLayer(guessLine);
        guessLine = null;
      }
      map.setView([20, 0], 2);
    }

    document.getElementById('validateBtn').addEventListener('click', async () => {
      if (!guessMarker || !currentRound) return;

      const guessLat = guessMarker.getLatLng().lat;
      const guessLng = guessMarker.getLatLng().lng;
      const targetLat = currentRound.targetLat;
      const targetLng = currentRound.targetLng;

      const distance = haversine(guessLat, guessLng, targetLat, targetLng);
      const score = Math.round(5000 * Math.exp(-0.000002 * distance));

      targetMarker = L.marker([targetLat, targetLng], {
        icon: L.divIcon({
          className: 'target-marker',
          html: '<div style="width:20px;height:20px;background:#ef4444;border:3px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,0.5)"></div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map);

      guessLine = L.polyline([[guessLat, guessLng], [targetLat, targetLng]], {
        color: '#3b82f6',
        weight: 2,
        dashArray: '5, 10'
      }).addTo(map);

      map.fitBounds([[guessLat, guessLng], [targetLat, targetLng]], {padding: [50, 50]});

      await saveScore(score, distance);

      document.getElementById('gameScore').textContent = `${totalScore} pts`;
      document.getElementById('resultScore').textContent = `+${score}`;
      document.getElementById('resultProgress').style.width = `${(score/5000)*100}%`;
      document.getElementById('resultDistance').textContent = `${Math.round(distance/1000)} km`;
      document.getElementById('resultTotal').textContent = totalScore;

      const overlay = document.getElementById('resultOverlay');
      overlay.classList.add('active');

      let countdown = 5;
      const countdownEl = document.getElementById('resultCountdown');
      const interval = setInterval(() => {
        countdown--;
        countdownEl.textContent = `Retour dans ${countdown}s...`;
        if (countdown <= 0) {
          clearInterval(interval);
          overlay.classList.remove('active');
          document.getElementById('waitingScore').textContent = `${totalScore} pts`;
          show('s-waiting');
        }
      }, 1000);
    });

    if (window.location.search.includes('admin')) {
      signInAnonymously(auth).then(() => {
        show('s-admin');
        initAdmin();
      });
    }

    function initAdmin() {
      renderPresets();
      listenLeaderboard();
      listenPlayersAdmin();
      listenActiveRoundAdmin();

      document.querySelectorAll('.diff-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          document.querySelectorAll('.diff-tag').forEach(t => t.classList.remove('active'));
          tag.classList.add('active');
          currentFilter = tag.dataset.diff;
          renderPresets();
        });
      });

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        });
      });

      document.getElementById('broadcastBtn').addEventListener('click', async () => {
        if (!selectedPreset) return;
        const roundData = {
          id: `round_${Date.now()}`,
          imageUrl: selectedPreset.url,
          targetLat: selectedPreset.lat,
          targetLng: selectedPreset.lng,
          name: selectedPreset.name,
          active: true,
          startedAt: Date.now()
        };
        const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', 'activeRound');
        await setDoc(docRef, roundData);
      });

      document.getElementById('broadcastCustomBtn').addEventListener('click', async () => {
        const url = document.getElementById('customUrl').value;
        const lat = parseFloat(document.getElementById('customLat').value);
        const lng = parseFloat(document.getElementById('customLng').value);
        const name = document.getElementById('customName').value;

        if (!url || !lat || !lng || !name) {
          alert('Tous les champs sont requis');
          return;
        }

        const roundData = {
          id: `round_${Date.now()}`,
          imageUrl: url,
          targetLat: lat,
          targetLng: lng,
          name: name,
          active: true,
          startedAt: Date.now()
        };
        const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', 'activeRound');
        await setDoc(docRef, roundData);
      });

      document.getElementById('stopRoundBtn').addEventListener('click', async () => {
        const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', 'activeRound');
        await setDoc(docRef, { active: false }, { merge: true });
      });

      document.getElementById('resetScoresBtn').addEventListener('click', async () => {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer tous les scores ?')) return;

        const colRef = collection(db, 'artifacts', 'geoguessrclasse', 'public');
        const snapshot = await getDocs(colRef);
        const batch = writeBatch(db);

        snapshot.forEach((docSnap) => {
          if (docSnap.id.startsWith('lb_')) {
            batch.delete(docSnap.ref);
          }
        });

        await batch.commit();
      });
    }

    function renderPresets() {
      const filtered = currentFilter === 'all' ? PRESETS : PRESETS.filter(p => p.diff === currentFilter);
      const listEl = document.getElementById('presetsList');
      listEl.innerHTML = filtered.map(preset => `
        <button class="preset-btn" data-id="${preset.id}">
          <div class="preset-name">
            <span>${preset.flag}</span>
            <span>${preset.name}</span>
            <span class="diff-tag ${preset.diff}" style="margin-left:auto">${preset.diff}</span>
          </div>
          <div class="preset-region">${preset.region}</div>
        </button>
      `).join('');

      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPreset = PRESETS.find(p => p.id === btn.dataset.id);
          updateRoundPreview();
        });
      });
    }

    function updateRoundPreview() {
      if (!selectedPreset) return;
      const previewEl = document.getElementById('roundPreview');
      previewEl.innerHTML = `
        <div class="preview-title">${selectedPreset.flag} ${selectedPreset.name}</div>
        <div class="preview-details">
          <span>${selectedPreset.region}</span>
          <span class="diff-tag ${selectedPreset.diff}">${selectedPreset.diff}</span>
        </div>
        <p style="color: var(--muted); font-size: 14px">Lat: ${selectedPreset.lat}, Lng: ${selectedPreset.lng}</p>
      `;
      document.getElementById('broadcastBtn').disabled = false;
    }

    function listenLeaderboard() {
      const colRef = collection(db, 'artifacts', 'geoguessrclasse', 'public');
      onSnapshot(colRef, (snapshot) => {
        const players = [];
        snapshot.forEach((doc) => {
          if (doc.id.startsWith('lb_')) {
            players.push(doc.data());
          }
        });

        players.sort((a, b) => b.totalScore - a.totalScore);

        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const leaderboardEl = document.getElementById('leaderboard');
        leaderboardEl.innerHTML = players.map((p, i) => `
          <div class="leaderboard-item">
            ${i < 3 ? `<div class="leaderboard-medal">${medals[i]}</div>` : `<div class="leaderboard-rank">${i+1}</div>`}
            <div class="leaderboard-info">
              <div class="leaderboard-name">${p.pseudo}</div>
              <div class="leaderboard-rounds">${p.rounds} rounds</div>
            </div>
            <div class="leaderboard-score">${p.totalScore}</div>
          </div>
        `).join('');
      });
    }

    function listenPlayersAdmin() {
      const colRef = collection(db, 'artifacts', 'geoguessrclasse', 'public');
      onSnapshot(colRef, (snapshot) => {
        let count = 0;
        let totalScore = 0;
        let totalRounds = 0;

        snapshot.forEach((doc) => {
          if (doc.id.startsWith('lb_')) {
            count++;
            const data = doc.data();
            totalScore += data.totalScore || 0;
            totalRounds += data.rounds || 0;
          }
        });

        document.getElementById('statPlayers').textContent = count;
        document.getElementById('statAvgScore').textContent = count > 0 ? Math.round(totalScore / count) : 0;
      });
    }

    function listenActiveRoundAdmin() {
      const docRef = doc(db, 'artifacts', 'geoguessrclasse', 'public', 'activeRound');
      onSnapshot(docRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.data();
          const statusEl = document.getElementById('roundStatus');
          if (data.active) {
            statusEl.innerHTML = `
              <div class="status-active">‚úì Round actif : ${data.name}</div>
              <div style="color: var(--muted); font-size: 14px; margin-top: 8px">
                D√©marr√© il y a ${Math.round((Date.now() - data.startedAt) / 1000)}s
              </div>
            `;
            const currentRounds = parseInt(document.getElementById('statRounds').textContent) || 0;
            document.getElementById('statRounds').textContent = currentRounds + 1;
          } else {
            statusEl.innerHTML = '<div class="status-inactive">Aucun round actif</div>';
          }
        }
      });
    }
  </script>
</body>
</html>
