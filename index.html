<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GÃ©oClasse â€” DÃ©fi de Localisation</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<!-- Pannellum -->
<link rel="stylesheet" href="https://cdn.pannellum.org/2.5/pannellum.css"/>
<script src="https://cdn.pannellum.org/2.5/pannellum.js"></script>

<!-- Tailwind -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBols3D4_fpOMAtbBgOcoAYy9ejpvCJr70",
    authDomain: "geoguessrclasse.firebaseapp.com",
    projectId: "geoguessrclasse",
    storageBucket: "geoguessrclasse.firebasestorage.app",
    messagingSenderId: "157640260530",
    appId: "1:157640260530:web:454fbf0c10fd001cc682ab",
    measurementId: "G-08D4Z2QLHF"
  };

  const APP_ID = firebaseConfig.projectId || "geoclasse-demo";
  const COLLECTION_PATH = `artifacts/${APP_ID}/public`;

  let app, db, auth, uid;
  let currentRound = null;
  let userMarker = null;
  let guessLatLng = null;
  let map = null;
  let viewer = null;
  let totalScore = 0;
  let pseudo = "";
  let isAdmin = false;
  let adminLeaderboardUnsub = null;
  let roundUnsub = null;

  const ADMIN_CODE = "PROF2024";

  // â”€â”€ Init Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initFirebase() {
    if (!firebaseConfig.apiKey) {
      console.warn("Firebase non configurÃ© â€” mode dÃ©mo local activÃ©.");
      window.__demoMode = true;
      return false;
    }
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    try {
      const cred = await signInAnonymously(auth);
      uid = cred.user.uid;
    } catch(e) { console.error(e); }
    return true;
  }

  // â”€â”€ Score Calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calcScore(distanceMeters) {
    const maxScore = 5000;
    const k = 0.000002;
    return Math.round(maxScore * Math.exp(-k * distanceMeters));
  }

  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // â”€â”€ Map Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initMap() {
    if (map) { map.remove(); map = null; }
    map = L.map('game-map', { zoomControl: true, attributionControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19
    }).addTo(map);
    map.setView([20, 0], 2);
    map.on('click', e => {
      guessLatLng = e.latlng;
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: '',
          html: `<div style="width:18px;height:18px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 0 10px #10b98188;"></div>`,
          iconAnchor: [9,9]
        })
      }).addTo(map);
      document.getElementById('btn-validate').classList.remove('opacity-50', 'cursor-not-allowed');
      document.getElementById('btn-validate').disabled = false;
    });
  }

  // â”€â”€ Panorama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadPanorama(url) {
    if (viewer) { viewer.destroy(); viewer = null; }
    const el = document.getElementById('panorama');
    el.innerHTML = '';
    viewer = pannellum.viewer('panorama', {
      type: 'equirectangular',
      panorama: url,
      autoLoad: true,
      showControls: false,
      compass: false,
      hotSpotDebug: false
    });
  }

  // â”€â”€ Screen Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  // â”€â”€ Submit Score to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function submitScore(roundId, score) {
    if (window.__demoMode) {
      console.log("[DEMO] Score soumis:", score);
      return;
    }
    const ref = doc(db, COLLECTION_PATH, `score_${roundId}_${uid}`);
    await setDoc(ref, { pseudo, score, totalScore, ts: Date.now() }, { merge: false });
  }

  async function updateLeaderboard(roundId, score) {
    if (window.__demoMode) return;
    const ref = doc(db, COLLECTION_PATH, `lb_${uid}`);
    await setDoc(ref, { pseudo, totalScore, lastScore: score, ts: Date.now() });
  }

  // â”€â”€ Listen to Active Round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function listenToRound() {
    if (window.__demoMode) return;
    const ref = doc(db, COLLECTION_PATH, 'activeRound');
    roundUnsub = onSnapshot(ref, snap => {
      if (!snap.exists()) return;
      const data = snap.data();
      if (!data.active) {
        showScreen('screen-lobby');
        return;
      }
      currentRound = data;
      startGameRound(data);
    });
  }

  function startGameRound(data) {
    showScreen('screen-game');
    guessLatLng = null;
    if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
    setTimeout(() => {
      initMap();
      loadPanorama(data.imageUrl);
    }, 100);
    document.getElementById('btn-validate').disabled = true;
    document.getElementById('btn-validate').classList.add('opacity-50', 'cursor-not-allowed');
    document.getElementById('hud-score').textContent = totalScore.toLocaleString();
  }

  // â”€â”€ Validate Guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function validateGuess() {
    if (!guessLatLng || !currentRound) return;
    const dist = haversineDistance(guessLatLng.lat, guessLatLng.lng, currentRound.targetLat, currentRound.targetLng);
    const score = calcScore(dist);
    totalScore += score;

    // Draw dashed line
    const targetLatLng = L.latLng(currentRound.targetLat, currentRound.targetLng);
    L.polyline([guessLatLng, targetLatLng], {
      color: '#3b82f6', weight: 2, dashArray: '6 4', opacity: 0.9
    }).addTo(map);

    // Target marker
    L.marker(targetLatLng, {
      icon: L.divIcon({
        className: '',
        html: `<div style="width:20px;height:20px;background:#ef4444;border:3px solid #fff;border-radius:50%;box-shadow:0 0 12px #ef444488;"></div>`,
        iconAnchor: [10,10]
      })
    }).addTo(map);

    map.fitBounds([guessLatLng, targetLatLng], { padding: [40, 40] });

    if (!window.__demoMode && currentRound.id) {
      await submitScore(currentRound.id, score);
      await updateLeaderboard(currentRound.id, score);
    }

    showResultOverlay(score, dist);
  }

  function showResultOverlay(score, dist) {
    const km = dist < 1000 ? `${Math.round(dist)} m` : `${(dist/1000).toFixed(1)} km`;
    const overlay = document.getElementById('result-overlay');
    document.getElementById('result-score').textContent = `+${score.toLocaleString()}`;
    document.getElementById('result-distance').textContent = km;
    document.getElementById('result-total').textContent = totalScore.toLocaleString();
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    setTimeout(() => {
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
      showScreen('screen-lobby');
    }, 5000);
  }

  // â”€â”€ Admin: Broadcast Round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function broadcastRound() {
    const imageUrl = document.getElementById('admin-image-url').value.trim();
    const lat = parseFloat(document.getElementById('admin-lat').value);
    const lng = parseFloat(document.getElementById('admin-lng').value);
    if (!imageUrl || isNaN(lat) || isNaN(lng)) {
      alert('Veuillez remplir tous les champs correctement.');
      return;
    }
    const roundId = `round_${Date.now()}`;
    const data = { id: roundId, imageUrl, targetLat: lat, targetLng: lng, active: true, startedAt: Date.now() };

    if (window.__demoMode) {
      currentRound = data;
      alert('[DEMO] Round diffusÃ© localement (Firebase non configurÃ©).');
      return;
    }
    const ref = doc(db, COLLECTION_PATH, 'activeRound');
    await setDoc(ref, data);
    document.getElementById('admin-broadcast-btn').textContent = 'âœ“ DiffusÃ© !';
    setTimeout(() => document.getElementById('admin-broadcast-btn').textContent = 'Diffuser le Round', 1500);
  }

  async function stopRound() {
    if (window.__demoMode) return;
    const ref = doc(db, COLLECTION_PATH, 'activeRound');
    await setDoc(ref, { active: false });
  }

  // â”€â”€ Admin: Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function listenLeaderboard() {
    if (window.__demoMode) return;
    const ref = collection(db, COLLECTION_PATH);
    adminLeaderboardUnsub = onSnapshot(ref, snap => {
      const players = [];
      snap.forEach(d => {
        // Only leaderboard entries (lb_ prefix)
        if (d.id.startsWith('lb_')) players.push(d.data());
      });
      players.sort((a, b) => b.totalScore - a.totalScore);
      renderLeaderboard(players);
    });
  }

  function renderLeaderboard(players) {
    const el = document.getElementById('admin-leaderboard');
    if (!players.length) { el.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Aucun joueur connectÃ©</p>'; return; }
    el.innerHTML = players.slice(0, 20).map((p, i) => `
      <div class="flex items-center justify-between py-2 px-3 rounded-xl mb-1 ${i===0?'bg-yellow-900 bg-opacity-30':i===1?'bg-gray-700 bg-opacity-30':i===2?'bg-orange-900 bg-opacity-30':'bg-gray-800 bg-opacity-40'}">
        <div class="flex items-center gap-3">
          <span class="text-lg font-bold w-8 text-center ${i===0?'text-yellow-400':i===1?'text-gray-300':i===2?'text-orange-400':'text-gray-500'}">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</span>
          <span class="font-semibold text-white">${p.pseudo}</span>
        </div>
        <span class="text-emerald-400 font-bold text-lg">${p.totalScore?.toLocaleString() || 0}</span>
      </div>
    `).join('');
  }

  // â”€â”€ DOM Ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('DOMContentLoaded', async () => {
    await initFirebase();

    // Join button
    document.getElementById('btn-join').addEventListener('click', () => {
      pseudo = document.getElementById('input-pseudo').value.trim();
      if (!pseudo) { document.getElementById('input-pseudo').classList.add('ring-2', 'ring-red-500'); return; }
      document.getElementById('lobby-pseudo').textContent = pseudo;
      document.getElementById('lobby-score').textContent = '0';
      showScreen('screen-lobby');
      listenToRound();
    });

    document.getElementById('input-pseudo').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('btn-join').click();
    });

    // Admin login
    document.getElementById('btn-admin-login').addEventListener('click', () => {
      const code = document.getElementById('input-admin-code').value;
      if (code === ADMIN_CODE) {
        isAdmin = true;
        showScreen('screen-admin');
        listenLeaderboard();
      } else {
        document.getElementById('admin-code-error').classList.remove('hidden');
      }
    });

    document.getElementById('btn-toggle-admin').addEventListener('click', () => {
      document.getElementById('admin-login-panel').classList.toggle('hidden');
    });

    // Broadcast
    document.getElementById('admin-broadcast-btn').addEventListener('click', broadcastRound);
    document.getElementById('admin-stop-btn').addEventListener('click', stopRound);

    // Validate guess
    document.getElementById('btn-validate').addEventListener('click', validateGuess);

    // Back to lobby from admin
    document.getElementById('admin-back-btn').addEventListener('click', () => {
      if (adminLeaderboardUnsub) adminLeaderboardUnsub();
      showScreen('screen-lobby');
    });

    document.getElementById('lobby-score').textContent = totalScore;
  });

  // Export for HTML onclick use
  window._app = { broadcastRound, stopRound, validateGuess };
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; }

  :root {
    --bg: #080c0f;
    --surface: #0f1419;
    --surface2: #171f27;
    --border: #1e2d3d;
    --emerald: #10b981;
    --emerald-dim: #064e3b;
    --blue: #3b82f6;
    --blue-dim: #1e3a5f;
    --text: #e2e8f0;
    --muted: #64748b;
  }

  html, body {
    margin: 0; padding: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    height: 100%; overflow: hidden;
  }

  .screen { width: 100vw; height: 100vh; }
  .hidden { display: none !important; }

  /* â”€â”€ SCROLLBAR â”€â”€ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* â”€â”€ WELCOME SCREEN â”€â”€ */
  #screen-welcome {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; overflow: hidden;
    background: var(--bg);
  }

  #screen-welcome::before {
    content: '';
    position: absolute; inset: 0;
    background: 
      radial-gradient(ellipse 80% 60% at 50% 0%, #0d2235 0%, transparent 70%),
      radial-gradient(ellipse 40% 40% at 80% 80%, #071a0f 0%, transparent 60%);
  }

  .globe-grid {
    position: absolute; inset: 0; overflow: hidden; opacity: 0.15;
    background-image: 
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    animation: gridSlide 20s linear infinite;
  }

  @keyframes gridSlide {
    from { background-position: 0 0; }
    to { background-position: 60px 60px; }
  }

  .logo-badge {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, var(--emerald), #059669);
    border-radius: 24px;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    box-shadow: 0 0 40px #10b98133, 0 8px 32px #00000060;
    margin-bottom: 24px;
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 40px #10b98133, 0 8px 32px #00000060; }
    50% { box-shadow: 0 0 70px #10b98155, 0 8px 32px #00000060; }
  }

  .welcome-card {
    position: relative; z-index: 10;
    background: rgba(15, 20, 25, 0.85);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 40px;
    width: 100%; max-width: 420px;
    backdrop-filter: blur(20px);
    box-shadow: 0 32px 80px #00000080;
  }

  .input-field {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .input-field:focus {
    border-color: var(--emerald);
    box-shadow: 0 0 0 3px #10b98122;
  }

  .btn-primary {
    width: 100%;
    background: linear-gradient(135deg, var(--emerald), #059669);
    border: none; border-radius: 12px;
    padding: 14px;
    color: #fff; font-family: 'Syne', sans-serif;
    font-size: 16px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.5px;
    transition: transform 0.15s, box-shadow 0.15s;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px #10b98133;
  }

  .btn-primary:active { transform: translateY(0); }

  /* â”€â”€ LOBBY â”€â”€ */
  #screen-lobby {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: var(--bg);
    position: relative; overflow: hidden;
  }

  #screen-lobby::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse 60% 60% at 50% 50%, #0a1a0f 0%, transparent 70%);
  }

  .waiting-pulse {
    width: 160px; height: 160px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    position: relative; margin-bottom: 32px;
  }

  .waiting-pulse::before, .waiting-pulse::after {
    content: ''; position: absolute; inset: 0;
    border-radius: 50%; border: 2px solid var(--emerald);
    animation: ripple 2.5s ease-out infinite;
  }

  .waiting-pulse::after { animation-delay: 1.25s; }

  @keyframes ripple {
    0% { transform: scale(0.8); opacity: 1; }
    100% { transform: scale(1.6); opacity: 0; }
  }

  .score-display {
    font-size: 72px; font-weight: 800;
    background: linear-gradient(135deg, var(--emerald), #34d399);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    line-height: 1; font-family: 'DM Mono', monospace;
  }

  /* â”€â”€ GAME SCREEN â”€â”€ */
  #screen-game {
    display: flex; flex-direction: column;
    background: var(--bg);
    overflow: hidden;
  }

  #panorama-wrap {
    flex: 6; position: relative; overflow: hidden;
    min-height: 0;
  }

  #panorama { width: 100%; height: 100%; }

  #map-wrap {
    flex: 4; position: relative;
    border-top: 2px solid var(--border);
    min-height: 0;
  }

  #game-map { width: 100%; height: 100%; }

  .hud {
    position: absolute; top: 16px; left: 16px; right: 16px;
    display: flex; justify-content: space-between; align-items: center;
    z-index: 1000; pointer-events: none;
  }

  .hud-score-pill {
    background: rgba(8, 12, 15, 0.85);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 8px 20px;
    backdrop-filter: blur(12px);
    font-family: 'DM Mono', monospace;
    font-size: 18px; font-weight: 700;
    color: var(--emerald);
  }

  #btn-validate {
    pointer-events: all;
    background: linear-gradient(135deg, var(--emerald), #059669);
    border: none; border-radius: 999px;
    padding: 12px 28px;
    color: #fff; font-family: 'Syne', sans-serif;
    font-size: 15px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.5px;
    transition: transform 0.15s, box-shadow 0.15s, opacity 0.2s;
    box-shadow: 0 4px 20px #10b98144;
  }

  #btn-validate:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px #10b98155;
  }

  /* â”€â”€ RESULT OVERLAY â”€â”€ */
  #result-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    flex-direction: column;
    align-items: center; justify-content: center;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 28px;
    padding: 48px 40px;
    text-align: center;
    max-width: 380px; width: 90%;
    box-shadow: 0 32px 80px #00000090;
  }

  .result-score-big {
    font-size: 80px; font-weight: 800;
    background: linear-gradient(135deg, #10b981, #34d399);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    font-family: 'DM Mono', monospace;
    line-height: 1;
  }

  /* â”€â”€ ADMIN SCREEN â”€â”€ */
  #screen-admin {
    display: flex; flex-direction: column;
    background: var(--bg); overflow-y: auto;
    padding: 24px;
  }

  .admin-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .admin-title {
    font-size: 13px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 16px;
  }

  .btn-admin {
    background: linear-gradient(135deg, var(--blue), #2563eb);
    border: none; border-radius: 10px;
    padding: 12px 24px;
    color: #fff; font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
  }

  .btn-admin:hover { transform: translateY(-1px); }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border: none; border-radius: 10px;
    padding: 12px 24px;
    color: #fff; font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s;
  }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 20px;
    color: var(--muted); font-family: 'Syne', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s;
  }

  .btn-secondary:hover { color: var(--text); border-color: var(--blue); }

  .label { font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 6px; letter-spacing: 1px; text-transform: uppercase; }

  /* â”€â”€ Responsive game layout â”€â”€ */
  @media (orientation: landscape) and (max-height: 600px) {
    #screen-game { flex-direction: row; }
    #panorama-wrap { flex: 6; border-top: none; border-right: 2px solid var(--border); }
    #map-wrap { flex: 4; }
    .hud { top: 8px; left: 8px; right: 8px; }
  }

  /* Map attribution */
  .leaflet-control-attribution { display: none; }

  /* Pannellum overrides */
  .pnlm-controls { display: none; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: WELCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-welcome" class="screen">
  <div class="globe-grid"></div>
  
  <div class="welcome-card" style="position:relative;z-index:10;">
    <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:32px;">
      <div class="logo-badge">ğŸŒ</div>
      <h1 style="font-size:32px;font-weight:800;margin:0 0 6px;letter-spacing:-0.5px;">GÃ©oClasse</h1>
      <p style="color:var(--muted);font-size:14px;margin:0;letter-spacing:1px;text-transform:uppercase;">DÃ©fi de Localisation</p>
    </div>

    <div style="margin-bottom:16px;">
      <div class="label">Ton pseudo</div>
      <input id="input-pseudo" class="input-field" type="text" placeholder="Ex: Thomas42" maxlength="20" autocomplete="off"/>
    </div>

    <button id="btn-join" class="btn-primary">Rejoindre la Partie â†’</button>

    <!-- Admin toggle -->
    <div style="margin-top:24px;border-top:1px solid var(--border);padding-top:20px;">
      <button id="btn-toggle-admin" class="btn-secondary" style="width:100%;font-size:12px;color:var(--muted);">
        ğŸ” AccÃ¨s Professeur
      </button>
      <div id="admin-login-panel" class="hidden" style="margin-top:14px;">
        <div class="label">Code admin</div>
        <input id="input-admin-code" class="input-field" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="margin-bottom:10px;"/>
        <p id="admin-code-error" class="hidden" style="color:#ef4444;font-size:12px;margin:0 0 8px;">Code incorrect</p>
        <button id="btn-admin-login" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px;color:var(--text);font-family:'Syne',sans-serif;font-size:14px;font-weight:600;cursor:pointer;">
          AccÃ©der Ã  la Console
        </button>
      </div>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen hidden" style="display:none;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;">
  <div style="position:absolute;inset:0;background:radial-gradient(ellipse 60% 60% at 50% 50%, #0a1a0f 0%, transparent 70%);"></div>
  
  <div style="position:relative;z-index:10;text-align:center;">
    <div class="waiting-pulse" style="margin:0 auto 32px;">
      <div style="width:80px;height:80px;background:var(--emerald-dim);border-radius:50%;border:2px solid var(--emerald);display:flex;align-items:center;justify-content:center;font-size:32px;">â³</div>
    </div>
    
    <p style="color:var(--muted);font-size:13px;letter-spacing:2px;text-transform:uppercase;margin:0 0 8px;">Bienvenue,</p>
    <h2 id="lobby-pseudo" style="font-size:36px;font-weight:800;margin:0 0 32px;color:var(--text);"></h2>
    
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px 48px;">
      <p style="color:var(--muted);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin:0 0 8px;">Score Total</p>
      <div class="score-display" id="lobby-score">0</div>
      <p style="color:var(--muted);font-size:13px;margin:16px 0 0;">pts</p>
    </div>
    
    <p style="color:var(--muted);font-size:13px;margin-top:32px;animation:blink 2s ease-in-out infinite;">
      En attente du professeurâ€¦
    </p>
  </div>

  <style>@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }</style>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="screen hidden">

  <!-- HUD -->
  <div class="hud" style="position:absolute;top:16px;left:16px;right:16px;z-index:1000;display:flex;justify-content:space-between;align-items:center;pointer-events:none;">
    <div class="hud-score-pill">
      <span style="color:var(--muted);font-size:11px;letter-spacing:1px;font-family:'Syne',sans-serif;font-weight:700;">SCORE </span>
      <span id="hud-score">0</span>
    </div>
    <button id="btn-validate" disabled class="opacity-50 cursor-not-allowed">
      âœ“ Valider ma position
    </button>
  </div>

  <!-- Panorama -->
  <div id="panorama-wrap">
    <div id="panorama" style="width:100%;height:100%;"></div>
  </div>

  <!-- Map -->
  <div id="map-wrap">
    <div id="game-map"></div>
    <div style="position:absolute;bottom:12px;left:12px;z-index:500;background:rgba(8,12,15,0.8);border:1px solid var(--border);border-radius:8px;padding:6px 12px;backdrop-filter:blur(8px);font-size:11px;color:var(--muted);pointer-events:none;">
      ğŸ“ Cliquez sur la carte pour placer votre hypothÃ¨se
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULT OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="result-overlay" class="hidden">
  <div class="result-card">
    <div style="font-size:48px;margin-bottom:8px;">ğŸ¯</div>
    <p style="color:var(--muted);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin:0 0 4px;">Points gagnÃ©s</p>
    <div class="result-score-big" id="result-score">0</div>
    
    <div style="display:flex;justify-content:center;gap:24px;margin:28px 0;padding:20px;background:var(--surface2);border-radius:16px;">
      <div style="text-align:center;">
        <p style="color:var(--muted);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 4px;">Distance</p>
        <p id="result-distance" style="font-size:22px;font-weight:800;color:var(--blue);margin:0;font-family:'DM Mono',monospace;"></p>
      </div>
      <div style="width:1px;background:var(--border);"></div>
      <div style="text-align:center;">
        <p style="color:var(--muted);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 4px;">Total</p>
        <p id="result-total" style="font-size:22px;font-weight:800;color:var(--emerald);margin:0;font-family:'DM Mono',monospace;"></p>
      </div>
    </div>
    
    <p style="color:var(--muted);font-size:13px;margin:0;">Retour au lobby dans 5 secondesâ€¦</p>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-admin" class="screen hidden" style="background:var(--bg);overflow-y:auto;">
  <div style="max-width:900px;margin:0 auto;padding:24px;">
    
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--blue),#2563eb);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;">ğŸ‘¨â€ğŸ«</div>
        <div>
          <h1 style="margin:0;font-size:22px;font-weight:800;">Console Professeur</h1>
          <p style="margin:0;color:var(--muted);font-size:12px;">GÃ©rez vos rounds en temps rÃ©el</p>
        </div>
      </div>
      <button id="admin-back-btn" class="btn-secondary">â† Retour</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      
      <!-- Left column -->
      <div>
        <!-- Broadcast form -->
        <div class="admin-card">
          <div class="admin-title">ğŸš€ Nouveau Round</div>
          
          <div style="margin-bottom:14px;">
            <div class="label">URL de l'image 360Â°</div>
            <input id="admin-image-url" class="input-field" type="url" 
              placeholder="https://example.com/panorama.jpg"
              value="https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/All_Gizah_Pyramids.jpg/2560px-All_Gizah_Pyramids.jpg"/>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
            <div>
              <div class="label">Latitude cible</div>
              <input id="admin-lat" class="input-field" type="number" step="0.0001" placeholder="29.9792" value="29.9792"/>
            </div>
            <div>
              <div class="label">Longitude cible</div>
              <input id="admin-lng" class="input-field" type="number" step="0.0001" placeholder="31.1342" value="31.1342"/>
            </div>
          </div>
          
          <div style="display:flex;gap:10px;">
            <button id="admin-broadcast-btn" class="btn-admin" style="flex:1;">ğŸ“¡ Diffuser le Round</button>
            <button id="admin-stop-btn" class="btn-danger">â¹</button>
          </div>
        </div>

        <!-- Sample locations -->
        <div class="admin-card">
          <div class="admin-title">ğŸ“š Exemples de Lieux</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn-secondary" style="text-align:left;font-size:12px;" onclick="
              document.getElementById('admin-image-url').value='https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/All_Gizah_Pyramids.jpg/2560px-All_Gizah_Pyramids.jpg';
              document.getElementById('admin-lat').value=29.9792;
              document.getElementById('admin-lng').value=31.1342;">
              ğŸ›ï¸ Pyramides de Gizeh (Ã‰gypte)
            </button>
            <button class="btn-secondary" style="text-align:left;font-size:12px;" onclick="
              document.getElementById('admin-image-url').value='https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Empire_State_Building_%28aerial_view%29.jpg/1280px-Empire_State_Building_%28aerial_view%29.jpg';
              document.getElementById('admin-lat').value=40.7484;
              document.getElementById('admin-lng').value=-73.9967;">
              ğŸ—½ New York, USA
            </button>
            <button class="btn-secondary" style="text-align:left;font-size:12px;" onclick="
              document.getElementById('admin-image-url').value='https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Eiffelturm_Paris.jpg/800px-Eiffelturm_Paris.jpg';
              document.getElementById('admin-lat').value=48.8584;
              document.getElementById('admin-lng').value=2.2945;">
              ğŸ—¼ Tour Eiffel, Paris
            </button>
          </div>
        </div>
      </div>

      <!-- Right column: Leaderboard -->
      <div>
        <div class="admin-card" style="height:calc(100% - 0px);">
          <div class="admin-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>ğŸ† Classement Temps RÃ©el</span>
            <span id="player-count" style="font-size:11px;color:var(--muted);letter-spacing:0;text-transform:none;font-weight:400;"></span>
          </div>
          <div id="admin-leaderboard">
            <p style="color:var(--muted);font-size:13px;text-align:center;padding:32px 0;">
              En attente des joueursâ€¦
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Status banner -->
    <div style="margin-top:16px;padding:16px;background:rgba(16,185,129,0.08);border:1px solid var(--emerald-dim);border-radius:12px;">
      <p style="margin:0;font-size:12px;color:var(--emerald);line-height:1.6;">
        <strong>âœ… Firebase connectÃ© :</strong> Projet <code style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px;">geoguessrclasse</code> â€” Les donnÃ©es sont synchronisÃ©es en temps rÃ©el.
      </p>
    </div>
  </div>
</div>

</body>
</html>
